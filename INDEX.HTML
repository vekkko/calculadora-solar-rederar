<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Sistemas Solares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="flex h-screen bg-gray-100">

    <!-- Sidebar de Navegación -->
    <div class="w-20 bg-blue-900 text-white flex flex-col items-center py-8 space-y-6">
        <div class="mb-8">
            <img src="https://i.postimg.cc/S2hzCGwP/LOGO-2024.jpg" alt="Logo de Rederar" class="h-12 w-12 rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/48x48?text=Logo';" />
        </div>
        <button id="btn-clientData" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors bg-blue-800 text-white">
            <img src="https://i.postimg.cc/hhYfTP1W/logo-clientes.png" alt="Logo Cliente" class="h-8 w-8" onerror="this.onerror=null; this.src='https://placehold.co/32x32?text=Client';" />
            <span class="text-xs text-center">Datos del Cliente</span>
        </button>
        <button id="btn-onGrid" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors text-gray-300 hover:text-white">
            <img src="https://i.postimg.cc/GTQdrH69/logo-on-grid.png" alt="Logo On-Grid" class="h-8 w-8" onerror="this.onerror=null; this.src='https://placehold.co/32x32?text=On';" />
            <span class="text-xs text-center">On-Grid</span>
        </button>
        <button id="btn-offGrid" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors text-gray-300 hover:text-white">
            <img src="https://i.postimg.cc/Sn9BDq2v/logo-off-grid.png" alt="Logo Off-Grid" class="h-8 w-8" onerror="this.onerror=null; this.src='https://placehold.co/32x32?text=Off';" />
            <span class="text-xs text-center">Off-Grid</span>
        </button>
        <button id="btn-termotanque" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors text-gray-300 hover:text-white">
            <img src="https://i.postimg.cc/dDcgFRvx/logo-termotanquesolar.png" alt="Logo Termotanque" class="h-8 w-8" onerror="this.onerror=null; this.src='https://placehold.co/32x32?text=Tank';" />
            <span class="text-xs text-center">Termotanque</span>
        </button>
    </div>

    <!-- Contenido Principal -->
    <div class="flex-1 flex flex-col bg-gray-100">
        <div class="bg-blue-900 text-white text-center py-4 rounded-t-xl">
            <img src="https://i.postimg.cc/S2hzCGwP/LOGO-2024.jpg" alt="Logo de Rederar" class="h-24 w-24 rounded-lg mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/96x96?text=Logo';" />
            <h1 class="text-2xl font-bold text-white">Calculadora Sistemas Solares Inicial</h1>
        </div>
        <div class="flex-1 overflow-y-auto p-8">
            <div id="content-area" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
                <!-- Secciones de Contenido (renderizadas por JS) -->
                <div id="clientData-section" class="flex-1">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Datos del Cliente</h1>
                    <p class="text-sm text-gray-600 mb-6">Ingresa los datos del cliente para comenzar con el dimensionamiento de los sistemas.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Nombre y Apellido</label>
                            <input type="text" id="clientName" placeholder="e.g., Juan Pérez" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label for="clientAddress" class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                            <input type="text" id="clientAddress" placeholder="e.g., Av. Siempreviva 742" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label for="clientProvince" class="block text-sm font-medium text-gray-700 mb-1">Provincia</label>
                            <select id="clientProvince" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Selecciona una provincia</option>
                                <option value="Buenos Aires">Buenos Aires</option>
                                <option value="Catamarca">Catamarca</option>
                                <option value="Chaco">Chaco</option>
                                <option value="Chubut">Chubut</option>
                                <option value="Ciudad Autónoma de Buenos Aires">Ciudad Autónoma de Buenos Aires</option>
                                <option value="Córdoba">Córdoba</option>
                                <option value="Corrientes">Corrientes</option>
                                <option value="Entre Ríos">Entre Ríos</option>
                                <option value="Formosa">Formosa</option>
                                <option value="Jujuy">Jujuy</option>
                                <option value="La Pampa">La Pampa</option>
                                <option value="La Rioja">La Rioja</option>
                                <option value="Mendoza">Mendoza</option>
                                <option value="Misiones">Misiones</option>
                                <option value="Neuquén">Neuquén</option>
                                <option value="Río Negro">Río Negro</option>
                                <option value="Salta">Salta</option>
                                <option value="San Juan">San Juan</option>
                                <option value="San Luis">San Luis</option>
                                <option value="Santa Cruz">Santa Cruz</option>
                                <option value="Santa Fe">Santa Fe</option>
                                <option value="Santiago del Estero">Santiago del Estero</option>
                                <option value="Tierra del Fuego">Tierra del Fuego</option>
                                <option value="Tucumán">Tucumán</option>
                            </select>
                        </div>
                    </div>
                    <p id="clientDataMessage" class="hidden mt-4 p-4 bg-green-100 rounded-lg text-green-800 text-center font-bold">
                        ¡Datos del cliente completados! Ahora puedes continuar con los cálculos.
                    </p>
                </div>

                <div id="onGrid-section" class="flex-1 hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Sistemas On-Grid</h1>
                    <img src="https://i.postimg.cc/GTQdrH69/logo-on-grid.png" alt="Logo On-Grid" class="h-24 mb-4 rounded-lg mx-auto" onerror="this.onerror=null; this.src='https://placehold.co/96x96?text=On-Grid';">
                    <p class="text-sm text-gray-600 mb-6">
                        Calcula la configuración On-Grid ideal para la vivienda del cliente.
                    </p>
                    <div class="space-y-4">
                        <div>
                            <label for="annualKwh" class="block text-sm font-medium text-gray-700 mb-1">Consumo anual de kWh</label>
                            <input type="number" id="annualKwh" placeholder="e.g., 3600" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                    </div>
                    <div class="mt-6 space-y-4">
                        <button id="calculate-onGrid" class="w-full p-3 rounded-lg font-bold transition-colors bg-gray-400 cursor-not-allowed text-white" disabled>
                            Calcular Sistema On-Grid
                        </button>
                        <div id="onGrid-result" class="hidden bg-blue-100 p-4 rounded-lg text-blue-800"></div>
                        <p id="onGridDataIncomplete" class="text-xs text-red-500 text-center">Para calcular el sistema debe tener cargados los datos del cliente y el consumo anual.</p>
                    </div>
                </div>

                <div id="offGrid-section" class="flex-1 hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Sistemas Off-Grid</h1>
                    <img src="https://i.postimg.cc/Sn9BDq2v/logo-off-grid.png" alt="Logo Off-Grid" class="h-24 mb-4 rounded-lg mx-auto" onerror="this.onerror=null; this.src='https://placehold.co/96x96?text=Off-Grid';">
                    <p class="text-sm text-gray-600 mb-6">
                        Dimensiona un sistema solar aislado de la red eléctrica.
                    </p>

                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/2">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Seleccionar Electrodomésticos</h3>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                                <select id="applianceSelect" class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-500 transition duration-200">
                                    <!-- Opciones se llenarán con JavaScript -->
                                </select>
                                <button id="addApplianceBtn" class="w-full sm:w-1/3 p-3 rounded-lg font-bold transition-colors bg-blue-600 hover:bg-blue-700 text-white shadow-md">
                                    Añadir
                                </button>
                            </div>
                            
                            <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-4">2. Lista de Consumo</h3>
                            <div id="appliances-container" class="space-y-4">
                                <!-- Appliance rows will be added here dynamically -->
                            </div>
                        </div>
                        
                        <div class="w-full md:w-1/2">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">3. Parámetros del Sistema</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="daysOfAutonomy" class="block text-sm font-medium text-gray-700 mb-1">Días de autonomía deseados (sin sol)</label>
                                    <input type="number" id="daysOfAutonomy" placeholder="e.g., 2" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                            </div>
                            <div class="mt-6 space-y-4">
                                <button id="calculate-offGrid" class="w-full p-3 rounded-lg font-bold transition-colors bg-gray-400 cursor-not-allowed text-white" disabled>
                                    Calcular Sistema Off-Grid
                                </button>
                                <div id="offGrid-result" class="hidden bg-blue-100 p-4 rounded-lg text-blue-800"></div>
                                <p id="offGridDataIncomplete" class="text-xs text-red-500 text-center">Para calcular el sistema debe tener cargados los datos del cliente y los valores de consumo.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="termotanque-section" class="flex-1 hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Termotanques Solares</h1>
                    <img src="https://i.postimg.cc/dDcgFRvx/logo-termotanquesolar.png" alt="Logo Termotanque" class="h-24 mb-4 rounded-lg mx-auto" onerror="this.onerror=null; this.src='https://placehold.co/96x96?text=Termotanque';">
                    <p class="text-sm text-gray-600 mb-6">Dimensiona el termotanque solar ideal para tu vivienda y solicita una cotización. Responde las siguientes preguntas.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="personCount" class="block text-sm font-medium text-gray-700 mb-1">Cantidad de personas en la vivienda</label>
                            <input type="number" id="personCount" placeholder="e.g., 4" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">¿Hay menores de 10 años en la vivienda?</label>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasMinors" value="si" class="form-radio text-blue-600" />
                                    <span class="ml-2 text-gray-700">Sí</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasMinors" value="no" class="form-radio text-blue-600" />
                                    <span class="ml-2 text-gray-700">No</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">¿Utilizará una bomba presurizadora?</label>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasPressurizer" value="si" class="form-radio text-blue-600" />
                                    <span class="ml-2 text-gray-700">Sí</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasPressurizer" value="no" class="form-radio text-blue-600" />
                                    <span class="ml-2 text-gray-700">No</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label for="waterType" class="block text-sm font-medium text-gray-700 mb-1">¿El agua de suministro es salada o dulce?</label>
                            <select id="waterType" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Selecciona</option>
                                <option value="dulce">Dulce</option>
                                <option value="salada">Salada</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 space-y-4">
                        <button id="calculate-termotanque" class="w-full p-3 rounded-lg font-bold transition-colors bg-gray-400 cursor-not-allowed text-white" disabled>
                            Calcular Termotanque Solar
                        </button>
                        <div id="termotanque-result" class="hidden bg-blue-100 p-4 rounded-lg text-blue-800"></div>
                        <p id="clientDataIncomplete" class="text-xs text-red-500 text-center">Para calcular el sistema debe tener cargados los datos del cliente.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie de página -->
        <div class="bg-blue-900 text-white text-center py-2">
            <div class="flex items-center justify-center text-xs">
                <span>Sistema creado por REDERAR,</span>
                <img src="https://i.postimg.cc/S2hzCGwP/LOGO-2024.jpg" alt="Logo de Rederar" class="h-4 w-4 rounded-sm mx-1" onerror="this.onerror=null; this.src='https://placehold.co/16x16?text=R';">
                <span>© todos los derechos reservados.</span>
            </div>
        </div>
    </div>

    <!-- Modal de Bloqueo de Software -->
    <div id="software-lock-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-lg text-center shadow-2xl w-full max-w-sm border-2 border-red-600">
            <h2 class="text-3xl font-bold text-red-600 mb-4">Software Bloqueado</h2>
            <p id="lock-message" class="text-lg text-gray-700 mb-6">El periodo de uso del software ha finalizado. Por favor, ingresa la contraseña para desbloquearlo.</p>
            <div id="unlock-form" class="flex flex-col space-y-4">
                <input type="password" id="unlock-code" placeholder="Ingresa la clave aquí" class="w-full p-3 rounded-lg border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button id="unlock-button" class="w-full p-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition-colors">Desbloquear</button>
            </div>
        </div>
    </div>

    <!-- Modal de Mensajes -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl w-80">
            <h3 class="text-lg font-bold mb-4">Mensaje del Sistema</h3>
            <p id="modal-message-text" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="close-modal" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Nuevo: Modal para agregar electrodoméstico "Otro" -->
    <div id="custom-appliance-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Añadir Electrodoméstico Personalizado</h3>
            <div class="space-y-4">
                <div>
                    <label for="customApplianceName" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="customApplianceName" placeholder="e.g., Bomba para Piscina" class="mt-1 w-full p-3 rounded-lg border border-gray-300" />
                </div>
                <div>
                    <label for="customAppliancePower" class="block text-sm font-medium text-gray-700">Potencia (W)</label>
                    <input type="number" id="customAppliancePower" placeholder="e.g., 500" class="mt-1 w-full p-3 rounded-lg border border-gray-300" />
                </div>
                <div>
                    <label for="customApplianceConsumption" class="block text-sm font-medium text-gray-700">Consumo por hora (Wh)</label>
                    <input type="number" id="customApplianceConsumption" placeholder="e.g., 250" class="mt-1 w-full p-3 rounded-lg border border-gray-300" />
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-custom-appliance" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-bold hover:bg-gray-400 transition-colors">Cancelar</button>
                <button id="add-custom-appliance" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Añadir</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Variables de estado
        let systemType = 'clientData';
        let isSessionActive = true;
        let isClientDataComplete = false;
        let appliances = [];

        // Nuevo: Variables de bloqueo de software basadas en tiempo de uso
        let isSoftwareLocked = false;
        const firstUnlockCode = 'CLAVE1'; 
        let isFirstUnlockCompleted = false;
        const futureKeys = ['V1E9K6K6O1', '204GGAGAO0', 'CD11JSJSVD', '43R3LOLO53', '62EUQ6Q6M2', 'WRVN1K1KDR', 'OFZ3DCDCPF', 'AWGC4I4ISW', 'O1513K3K71', 'OJB3TSTSLJ', 'YA2QMYMYEA', '8JZJ5C5CPJ', 'WFNZH0H0PF', 'UO84C2C20O', 'CTHPFOFOFT', 'S3FFHGHG53', 'QIMQIQIQ6I', '87RVPWPWX7', 'OFZ7XCXCTF', 'I8CO8U8UG8', 'WD1LRSRSVD', '473ZL8L8X7', 'M6Q6YMYMI6', 'C3FV9G9G13', 'KZRRTOTO5Z', 'ISW8OUOUWS', 'SDDL7474RD', '0VVFHKHKDV', 'EYUQEEEEQY', '0FBRLOLOPF', '43R3LOLO53', 'U4SKS2S2K4', 'KT5D3G3GBT', '0NJNL4L4HN', '66EMA6A6I6', 'WFNZH0H0PF', 'SBN7DWDWXB', 'AC0SKIKICC', 'ODDPN4N4VD', 'OFZ7XCXCTF', '2EYM6262AE', 'CFNJP0P0TF', '0FBRLOLOPF', '2KK0WAWA4K', 'SLLD7K7KJL', 'GRVZTKTKDR', 'U222MUMUM2', 'WJNR1414LJ', 'GBBJ9K9KXB', '2KK0WAWA4K'];
        let futureKeySchedule = [];

        // Generar un ID de dispositivo único
        const deviceId = crypto.randomUUID();

        // Base de datos simulada para HPS (Horas Pico Solar) y equipamiento
        const hpsData = {
            "Buenos Aires": 3.8, "Catamarca": 4.5, "Chaco": 4.1, "Chubut": 3.6, "Ciudad Autónoma de Buenos Aires": 3.7, "Córdoba": 4.3, "Corrientes": 4.0, "Entre Ríos": 3.9, "Formosa": 4.2, "Jujuy": 4.6, "La Pampa": 4.1, "La Rioja": 4.4, "Mendoza": 4.7, "Misiones": 3.5, "Neuquén": 4.2, "Río Negro": 4.0, "Salta": 4.5, "San Juan": 4.8, "San Luis": 4.3, "Santa Cruz": 3.3, "Santa Fe": 4.0, "Santiago del Estero": 4.4, "Tierra del Fuego": 2.8, "Tucumán": 4.2
        };
        const panelData = { 'tipo': 'JA Solar 550W', 'potencia': 550 };
        const inverterData = {
            'onGrid': [{ 'potencia': 2500, 'nombre': 'Inversor On-Grid de 2.5 kW' }, { 'potencia': 3000, 'nombre': 'Inversor On-Grid de 3 kW' }, { 'potencia': 4000, 'nombre': 'Inversor On-Grid de 4 kW' }, { 'potencia': 5000, 'nombre': 'Inversor On-Grid de 5 kW' }, { 'potencia': 8000, 'nombre': 'Inversor On-Grid de 8 kW' }, { 'potencia': 10000, 'nombre': 'Inversor On-Grid de 10 kW' }, { 'potencia': 15000, 'nombre': 'Inversor On-Grid de 15 kW' }],
            'offGrid': [{ 'potencia': 3000, 'nombre': 'Inversor Off-Grid de 3 kW' }, { 'potencia': 5000, 'nombre': 'Inversor Off-Grid de 5 kW' }, { 'potencia': 8000, 'nombre': 'Inversor Off-Grid de 8 kW' }]
        };
        // Baterías actualizadas con la información del usuario
        const batteryData = {
            'leadAcid': {
                name: 'Batería de Plomo-Ácido',
                dod: 0.5,
                voltages: [
                    { v: 12, capacitiesAh: [100, 200, 250] },
                    { v: 24, capacitiesAh: [100, 200, 300, 400] },
                    { v: 48, capacitiesAh: [200, 300, 400, 500] }
                ]
            },
            'lifepo4': {
                name: 'Batería de Litio (LiFePO4)',
                dod: 0.9,
                voltages: [
                    { v: 12, capacitiesAh: [100, 200, 250] },
                    { v: 24, capacitiesAh: [100, 200, 300] },
                    { v: 48, capacitiesAh: [200, 300, 400] }
                ]
            }
        };

        // Datos de electrodomésticos
        const applianceList = [
            { name: "Afeitadora", potencia: 5, consumo: 5 }, { name: "Aire acondicionado de 2200 frigorías F/C", potencia: 1350, consumo: 1013 }, { name: "Aire acondicionado de 3500 frigorías F/C", potencia: 2150, consumo: 1613 }, { name: "Aire acondicionado de 4500 frigorías F/C", potencia: 2800, consumo: 2153 }, { name: "Aire acondicionado de 2200 frigorías F/C - Inverter", potencia: 877.5, consumo: 658 }, { name: "Aire acondicionado de 3500 frigorías F/C - Inverter", potencia: 1397.5, consumo: 1048 }, { name: "Aire acondicionado de 4500 frigorías F/C - Inverter", potencia: 1820, consumo: 1365 }, { name: "Anafe vitrocerámica con hornalla de 120 mm de diámetro", potencia: 750, consumo: 750 }, { name: "Anafe vitrocerámica con hornalla de 140 mm de diámetro", potencia: 1250, consumo: 1250 }, { name: "Anafe vitrocerámica con hornalla de 175 mm de diámetro", potencia: 1500, consumo: 1500 }, { name: "Anafe vitrocerámica con hornalla de 200 mm de diámetro", potencia: 1800, consumo: 1800 }, { name: "Anafe vitrocerámica con hornalla de 215 mm de diámetro", potencia: 2110, consumo: 2110 }, { name: "Anafe vitrocerámica con hornalla de 220 mm de diámetro", potencia: 2350, consumo: 2350 }, { name: "Anafe resistivo con hornalla de 150 mm de diámetro", potencia: 1000, consumo: 1000 }, { name: "Anafe resistivo con hornalla de 190 mm de diámetro", potencia: 2000, consumo: 2000 }, { name: "Aspiradora", potencia: 1200, consumo: 1200 }, { name: "Batidora de mano", potencia: 300, consumo: 300 }, { name: "Bomba de agua de 1/2 HP", potencia: 380, consumo: 380 }, { name: "Bomba de agua de 3/4 HP", potencia: 570, consumo: 570 }, { name: "Cafetera de filtro eléctrica", potencia: 900, consumo: 900 }, { name: "Caloventilador chico c/termostato", potencia: 1500, consumo: 1500 }, { name: "Cargador de celular genérico", potencia: 5, consumo: 5 }, { name: "Computadora (sólo la CPU)", potencia: 200, consumo: 200 }, { name: "Extractor de aire para cocina o baño - 80 m3/hora", potencia: 12, consumo: 12 }, { name: "Extractor de aire para cocina o baño - 200 m3/hora", potencia: 20, consumo: 20 }, { name: "Extractor de aire para cocina o baño - 1200 m3/hora", potencia: 50, consumo: 50 }, { name: "Estufa halógena de 3 velas c/termostato", potencia: 1500, consumo: 1500 }, { name: "Estufa de cuarzo c/termostato", potencia: 1500, consumo: 1500 }, { name: "Freezer", potencia: 250, consumo: 113 }, { name: "Heladera", potencia: 150, consumo: 75 }, { name: "Heladera con freezer", potencia: 200, consumo: 90 }, { name: "Heladera con freezer - Inverter", potencia: 200, consumo: 35 }, { name: "Horno eléctrico de 25 a 30 litros c/termostato", potencia: 1500, consumo: 750 }, { name: "Horno eléctrico de 73 litros c/termostato, para empotrar", potencia: 2450, consumo: 1225 }, { name: "Lámpara de bajo consumo de 11W", potencia: 11, consumo: 11 }, { name: "Lámpara de bajo consumo de 15W", potencia: 15, consumo: 15 }, { name: "Lámpara de bajo consumo de 20W", potencia: 20, consumo: 20 }, { name: "Lámpara halógena de 100 W", potencia: 100, consumo: 100 }, { name: "Lámpara halógena de 40 W", potencia: 40, consumo: 40 }, { name: "Lámpara halógena de 60 W", potencia: 60, consumo: 60 }, { name: "Lámpara LED de 5 W", potencia: 5, consumo: 5 }, { name: "Lámpara LED de 9 W", potencia: 9, consumo: 9 }, { name: "Lámpara LED de 11 W", potencia: 11, consumo: 11 }, { name: "Lavarropas automático de 5 kg con calentamiento de agua", potencia: 2500, consumo: 875 }, { name: "Lavarropas automático de 5 kg", potencia: 500, consumo: 175 }, { name: "Lavarropas semi-automático de 5 kg", potencia: 200, consumo: 80 }, { name: "Lavavajilla para 12 cubiertos", potencia: 1500, consumo: 1125 }, { name: "Licuadora de mano o de pie", potencia: 600, consumo: 600 }, { name: "Lustraspiradora", potencia: 800, consumo: 720 }, { name: "Microondas", potencia: 800, consumo: 640 }, { name: "Minicomponentes", potencia: 60, consumo: 60 }, { name: "Monitor LED de 19\"", potencia: 22, consumo: 22 }, { name: "Notebook", potencia: 22, consumo: 22 }, { name: "Pava eléctrica de 1,7 litros", potencia: 2000, consumo: 2000 }, { name: "Plancha", potencia: 1500, consumo: 750 }, { name: "Planchita de pelo o buclera", potencia: 40, consumo: 40 }, { name: "Radiador eléctrico mediano c/termostato", potencia: 1500, consumo: 1500 }, { name: "Reproductor de DVD", potencia: 15, consumo: 15 }, { name: "Secador de cabellos", potencia: 2000, consumo: 2000 }, { name: "Secarropas a calor", potencia: 950, consumo: 950 }, { name: "Secarropas centrífugo", potencia: 380, consumo: 380 }, { name: "Televisor color de tubo fluorescente de 21\"", potencia: 75, consumo: 75 }, { name: "Televisor color de tubo fluorescente de 25\"", potencia: 155, consumo: 155 }, { name: "Televisor color de tubo fluorescente de 29\" a 34\"", potencia: 175, consumo: 175 }, { name: "Televisor LED de 40\"", potencia: 180, consumo: 180 }, { name: "Televisor LED 24\"", potencia: 40, consumo: 40 }, { name: "Televisor LED 32\" a 50''", potencia: 90, consumo: 90 }, { name: "Termotanque eléctrico c/termostato", potencia: 1500, consumo: 1500 }, { name: "Tostadora", potencia: 950, consumo: 950 }, { name: "Tubo fluorescente de 18 W", potencia: 18, consumo: 18 }, { name: "Tubo fluorescente de 36 W", potencia: 36, consumo: 36 }, { name: "Tubo fluorescente de 58 W", potencia: 58, consumo: 58 }, { name: "Ventilador de techo", potencia: 60, consumo: 60 }, { name: "Ventilador de pie", potencia: 90, consumo: 90 }, { name: "Vitroconvector 54 x 57 cm c/termostato", potencia: 1000, consumo: 1000 }, { name: "Vitroconvector 86 x 58 cm c/termostato", potencia: 2000, consumo: 2000 }, { name: "Vitroconvector 54 x 57 cm c/termostato", potencia: 1000, consumo: 1000 }, { name: "otro", potencia: 0, consumo: 0 }
        ];

        // Elementos del DOM
        const sidebarButtons = document.querySelectorAll('button[id^="btn-"]');
        const sections = document.querySelectorAll('[id$="-section"]');
        const clientNameInput = document.getElementById('clientName');
        const clientAddressInput = document.getElementById('clientAddress');
        const clientProvinceSelect = document.getElementById('clientProvince');
        const clientDataMessage = document.getElementById('clientDataMessage');
        const softwareLockModal = document.getElementById('software-lock-modal');
        const lockMessage = document.getElementById('lock-message');
        const unlockForm = document.getElementById('unlock-form');
        const unlockCodeInput = document.getElementById('unlock-code');
        const unlockButton = document.getElementById('unlock-button');
        const messageModal = document.getElementById('message-modal');
        const modalMessageText = document.getElementById('modal-message-text');
        const closeModalButton = document.getElementById('close-modal');

        // Elementos de On-Grid
        const annualKwhInput = document.getElementById('annualKwh');
        const calculateOnGridButton = document.getElementById('calculate-onGrid');
        const onGridResultDiv = document.getElementById('onGrid-result');
        const onGridDataIncompleteMessage = document.getElementById('onGridDataIncomplete');

        // Elementos de Off-Grid
        const applianceSelect = document.getElementById('applianceSelect');
        const addApplianceBtn = document.getElementById('addApplianceBtn');
        const appliancesContainer = document.getElementById('appliances-container');
        const daysOfAutonomyInput = document.getElementById('daysOfAutonomy');
        const calculateOffGridButton = document.getElementById('calculate-offGrid');
        const offGridResultDiv = document.getElementById('offGrid-result');
        const offGridDataIncompleteMessage = document.getElementById('offGridDataIncomplete');
        // Nuevos elementos para el modal "Otro"
        const customApplianceModal = document.getElementById('custom-appliance-modal');
        const customApplianceNameInput = document.getElementById('customApplianceName');
        const customAppliancePowerInput = document.getElementById('customAppliancePower');
        const customApplianceConsumptionInput = document.getElementById('customApplianceConsumption');
        const addCustomApplianceBtn = document.getElementById('add-custom-appliance');
        const cancelCustomApplianceBtn = document.getElementById('cancel-custom-appliance');


        // Elementos de Termotanque
        const calculateTermotanqueButton = document.getElementById('calculate-termotanque');
        const termotanqueResultDiv = document.getElementById('termotanque-result');
        const clientDataIncompleteMessage = document.getElementById('clientDataIncomplete');
        const personCountInput = document.getElementById('personCount');
        const hasMinorsInputs = document.querySelectorAll('input[name="hasMinors"]');
        const hasPressurizerInputs = document.querySelectorAll('input[name="hasPressurizer"]');
        const waterTypeSelect = document.getElementById('waterType');

        // Firebase-related variables
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let userId = null;
        let userDocRef = null;
        let sessionDocRef = null;
        let activationDocRef = null;
        let scheduleDocRef = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
        }

        // Función para mostrar un modal
        const showSystemMessage = (message) => {
            modalMessageText.textContent = message;
            messageModal.classList.remove('hidden');
        };

        const showLockModal = (message, showUnlockForm) => {
            lockMessage.textContent = message;
            if (showUnlockForm) {
                unlockForm.classList.remove('hidden');
            } else {
                unlockForm.classList.add('hidden');
            }
            softwareLockModal.classList.remove('hidden');
        };

        const hideLockModal = () => {
            softwareLockModal.classList.add('hidden');
        };

        // Función para cambiar de sección
        const showSection = (type) => {
            if (!isSessionActive || isSoftwareLocked) {
                return;
            }
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(type + '-section').classList.remove('hidden');

            sidebarButtons.forEach(btn => {
                btn.classList.remove('bg-blue-800', 'text-white');
                btn.classList.add('text-gray-300', 'hover:text-white');
            });
            document.getElementById('btn-' + type).classList.remove('text-gray-300', 'hover:text-white');
            document.getElementById('btn-' + type).classList.add('bg-blue-800', 'text-white');

            systemType = type;
            updateButtonStates();
        };

        // Función para actualizar el estado de los datos del cliente
        const updateClientDataState = () => {
            if (clientNameInput.value && clientAddressInput.value && clientProvinceSelect.value) {
                isClientDataComplete = true;
                clientDataMessage.classList.remove('hidden');
            } else {
                isClientDataComplete = false;
                clientDataMessage.classList.add('hidden');
            }
            updateButtonStates();
        };
        
        // Función para actualizar el estado de todos los botones de cálculo
        const updateButtonStates = () => {
            // Estado del botón de On-Grid
            const isAnnualKwhFilled = annualKwhInput.value !== '';
            if (isClientDataComplete && isAnnualKwhFilled) {
                calculateOnGridButton.disabled = false;
                calculateOnGridButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                calculateOnGridButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                onGridDataIncompleteMessage.classList.add('hidden');
            } else {
                calculateOnGridButton.disabled = true;
                calculateOnGridButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                calculateOnGridButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                if (systemType === 'onGrid' && (!isClientDataComplete || !isAnnualKwhFilled)) {
                    onGridDataIncompleteMessage.classList.remove('hidden');
                } else {
                    onGridDataIncompleteMessage.classList.add('hidden');
                }
            }

            // Estado del botón de Off-Grid
            const hasAppliances = appliances.length > 0 && appliances.some(item => (item.consumo > 0 && item.horas > 0));
            const daysOfAutonomyFilled = daysOfAutonomyInput.value > 0;
            
            if (isClientDataComplete && hasAppliances && daysOfAutonomyFilled) {
                calculateOffGridButton.disabled = false;
                calculateOffGridButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                calculateOffGridButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                offGridDataIncompleteMessage.classList.add('hidden');
            } else {
                calculateOffGridButton.disabled = true;
                calculateOffGridButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                calculateOffGridButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                if (systemType === 'offGrid' && (!isClientDataComplete || !hasAppliances || !daysOfAutonomyFilled)) {
                    offGridDataIncompleteMessage.classList.remove('hidden');
                } else {
                    offGridDataIncompleteMessage.classList.add('hidden');
                }
            }

            // Estado del botón de Termotanque
            const isTermotanqueDataComplete = personCountInput.value && (document.querySelector('input[name="hasMinors"]:checked') !== null) && (document.querySelector('input[name="hasPressurizer"]:checked') !== null) && waterTypeSelect.value;
            if (isClientDataComplete && isTermotanqueDataComplete) {
                calculateTermotanqueButton.disabled = false;
                calculateTermotanqueButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                calculateTermotanqueButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                clientDataIncompleteMessage.classList.add('hidden');
            } else {
                calculateTermotanqueButton.disabled = true;
                calculateTermotanqueButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                calculateTermotanqueButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                if (systemType === 'termotanque' && (!isClientDataComplete || !isTermotanqueDataComplete)) {
                    clientDataIncompleteMessage.classList.remove('hidden');
                } else {
                    clientDataIncompleteMessage.classList.add('hidden');
                }
            }
        };

        // Lógica de cálculo del termotanque
        const calculateTermotanque = () => {
            if (!isClientDataComplete) {
                showSystemMessage('Para calcular el sistema, primero debes completar los datos del cliente.');
                return;
            }
            const people = parseInt(personCountInput.value);
            let tankInfo = '';
            
            if (people <= 2) {
                tankInfo = '1 termotanque de 80 Litros';
            } else if (people === 3) {
                tankInfo = '1 termotanque de 150 Litros';
            } else if (people === 4) {
                tankInfo = '1 termotanque de 200 Litros';
            } else if (people === 5) {
                tankInfo = '1 termotanque de 250 Litros';
            } else if (people === 6) {
                tankInfo = '1 termotanque de 300 Litros';
            } else if (people === 7) {
                tankInfo = '1 termotanque de 200 Litros y otro de 150 Litros';
            } else if (people === 8) {
                tankInfo = '2 termotanques de 200 Litros';
            } else if (people === 9) {
                tankInfo = '1 termotanque de 250 Litros y otro de 200 Litros';
            } else if (people >= 10) {
                tankInfo = '2 termotanques de 250 Litros';
            } else {
                showSystemMessage('Por favor, ingresa un número de personas válido.');
                return;
            }
            
            const hasMinors = document.querySelector('input[name="hasMinors"]:checked').value === 'si';
            const hasPressurizer = document.querySelector('input[name="hasPressurizer"]:checked') ? document.querySelector('input[name="hasPressurizer"]:checked').value === 'si' : false;
            const waterType = waterTypeSelect.value;
            const filterRequired = waterType === 'salada';
            const thermostaticValveRequired = hasMinors;
            const tankType = hasPressurizer ? 'Heat Pipe (presurizado)' : 'Tubo de Vacío (gravedad)';
            
            let resultHTML = `<h3 class="font-bold">Resultado del Cálculo</h3><p class="mt-2">Configuración recomendada:</p><ul class="list-disc list-inside ml-4"><li><span class="font-bold">${tankInfo}</span></li></ul><p class="mt-2">Tipo de termotanque: <span class="font-bold">${tankType}</span></p>`;
            
            if (filterRequired) {
                resultHTML += `<p class="text-sm font-medium mt-2"><span class="font-bold">Importante:</span> Se recomienda utilizar un filtro para el cuidado del equipo, ya que el agua de suministro es salada.</p>`;
            }
            if (thermostaticValveRequired) {
                resultHTML += `<p class="text-sm font-medium mt-2"><span class="font-bold">Importante:</span> Por seguridad de los menores, se recomienda instalar una válvula termostática.</p>`;
            }
            resultHTML += `<p class="text-sm font-bold mt-4">Dimensionamiento Preliminar, los valores finales pueden variar.</p>`;
            termotanqueResultDiv.innerHTML = resultHTML;
            termotanqueResultDiv.classList.remove('hidden');
        };

        // Lógica de cálculo del sistema On-Grid
        const calculateOnGrid = () => {
            if (!isClientDataComplete) {
                showSystemMessage('Para calcular el sistema, primero debes completar los datos del cliente.');
                return;
            }
            const annualKwh = parseFloat(annualKwhInput.value);
            if (isNaN(annualKwh) || annualKwh <= 0) {
                showSystemMessage('Por favor, ingresa un valor de consumo anual de kWh válido.');
                return;
            }
            const clientProvince = clientProvinceSelect.value;
            const hps = hpsData[clientProvince];
            if (!hps) {
                showSystemMessage('No se encontraron datos de Horas Pico Solar para la provincia seleccionada. Intente de nuevo.');
                return;
            }
            const dailyKwh = annualKwh / 365;
            const requiredPower = (dailyKwh / hps) * 1000;
            const panelCount = Math.ceil(requiredPower / panelData.potencia);
            const totalSystemPower = panelCount * panelData.potencia;
            let recommendedInverter = null;
            for (const inverter of inverterData.onGrid) {
                if (totalSystemPower <= inverter.potencia) {
                    recommendedInverter = inverter;
                    break;
                }
            }
            if (!recommendedInverter) {
                recommendedInverter = inverterData.onGrid[inverterData.onGrid.length - 1];
            }
            const resultHTML = `<h3 class="font-bold">Resultado del Cálculo On-Grid</h3><p class="mt-2">Configuración recomendada:</p><ul class="list-disc list-inside ml-4"><li><span class="font-bold">${panelCount}</span> paneles solares de <span class="font-bold">${panelData.potencia}W</span> (${panelData.tipo})</li><li>Inversor: <span class="font-bold">${recommendedInverter.nombre}</span> (${recommendedInverter.potencia / 1000} kW)</li></ul><p class="mt-2 text-sm">Potencia total del sistema: <span class="font-bold">${totalSystemPower / 1000} kW</span></p><p class="text-sm font-bold mt-4">Dimensionamiento Preliminar, los valores finales pueden variar.</p>`;
            onGridResultDiv.innerHTML = resultHTML;
            onGridResultDiv.classList.remove('hidden');
        };

        // Lógica de cálculo del sistema Off-Grid (actualizada)
        const calculateOffGrid = () => {
            if (!isClientDataComplete) {
                showSystemMessage('Para calcular el sistema, primero debes completar los datos del cliente.');
                return;
            }

            const daysOfAutonomy = parseFloat(daysOfAutonomyInput.value);
            if (isNaN(daysOfAutonomy) || daysOfAutonomy <= 0) {
                showSystemMessage('Por favor, ingresa una cantidad de días de autonomía válida.');
                return;
            }
            
            let totalDailyWh = 0;
            appliances.forEach(item => {
                // Lógica actualizada: Para electrodomésticos con termostato (heladeras, freezers, ACs),
                // se utiliza el consumo por 8 horas al día, independientemente de las horas de uso ingresadas,
                // ya que su funcionamiento no es continuo.
                const applianceName = item.name.toLowerCase();
                const isThermostatic = applianceName.includes('heladera') || applianceName.includes('freezer') || applianceName.includes('aire acondicionado');

                let dailyConsumption;
                if (isThermostatic) {
                    dailyConsumption = (item.consumo || 0) * 8;
                } else {
                    dailyConsumption = (item.consumo || 0) * (item.horas || 0);
                }
                
                totalDailyWh += dailyConsumption;
            });

            if (totalDailyWh === 0) {
                showSystemMessage('Por favor, agrega al menos un electrodoméstico con horas de uso.');
                return;
            }

            const clientProvince = clientProvinceSelect.value;
            const hps = hpsData[clientProvince];
            if (!hps) {
                showSystemMessage('No se encontraron datos de Horas Pico Solar para la provincia seleccionada. Intente de nuevo.');
                return;
            }

            // Calculo de paneles
            const requiredPanelPowerWp = (totalDailyWh / hps) * 1.25;
            const panelCount = Math.ceil(requiredPanelPowerWp / panelData.potencia);
            
            // Selección de inversor
            let recommendedInverter = null;
            for (const inverter of inverterData.offGrid) {
                if (totalDailyWh / 1000 <= inverter.potencia / 1000) {
                    recommendedInverter = inverter;
                    break;
                }
            }
            if (!recommendedInverter) {
                recommendedInverter = inverterData.offGrid[inverterData.offGrid.length - 1];
            }
            const systemVoltage = 48; // Usar 48V como estándar para sistemas grandes

            // Generar resultado final con ambas propuestas de baterías
            let resultHTML = `<h3 class="font-bold">Resultado del Cálculo Off-Grid</h3>
                                <p class="mt-2">Consumo diario total: <span class="font-bold">${(totalDailyWh / 1000).toFixed(2)} kWh</span></p>
                                <p class="mt-2">Paneles: <span class="font-bold">${panelCount}</span> de <span class="font-bold">${panelData.potencia}W</span></p>
                                <p class="mt-2">Inversor: <span class="font-bold">${recommendedInverter.nombre}</span></p>
                                <p class="text-sm font-medium mt-4">Propuestas de Baterías: se puede utilizar cualquiera de las opciones, pero no se pueden mezclar tecnologías.</p>
                                <div class="space-y-4 mt-2">`;
            
            for (const type in batteryData) {
                const batteryType = batteryData[type];
                const requiredBatteryWh = (totalDailyWh * daysOfAutonomy) / batteryType.dod;
                const requiredBatteryAh = requiredBatteryWh / systemVoltage;

                const foundVoltage = batteryType.voltages.find(v => v.v === systemVoltage);
                if (foundVoltage) {
                    const foundCapacity = foundVoltage.capacitiesAh.find(c => c >= requiredBatteryAh);
                    const selectedCapacity = foundCapacity || Math.max(...foundVoltage.capacitiesAh);
                    const batteryCount = Math.ceil(requiredBatteryAh / selectedCapacity);

                    resultHTML += `
                        <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                            <h5 class="font-semibold">${batteryType.name}</h5>
                            <ul class="list-disc list-inside ml-4 mt-1">
                                <li><span class="font-bold">${batteryCount}</span> batería(s) de <span class="font-bold">${selectedCapacity} Ah</span> a <span class="font-bold">${systemVoltage} V</span></li>
                            </ul>
                        </div>
                    `;
                }
            }
            resultHTML += `</div><p class="text-sm font-bold mt-6">Dimensionamiento Preliminar, los valores finales pueden variar.</p>`;
            
            offGridResultDiv.innerHTML = resultHTML;
            offGridResultDiv.classList.remove('hidden');
        };

        // Llenar el dropdown con los datos de electrodomésticos
        const populateApplianceSelect = () => {
            applianceList.forEach(item => {
                const option = document.createElement('option');
                option.value = JSON.stringify(item);
                option.textContent = `${item.name} (${item.potencia} W)`;
                applianceSelect.appendChild(option);
            });
        };

        // Renderizar la lista de electrodomésticos seleccionados
        const renderApplianceList = () => {
            appliancesContainer.innerHTML = '';
            appliances.forEach((item, index) => {
                const applianceItem = document.createElement('div');
                applianceItem.className = 'flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 p-4 bg-gray-50 rounded-lg shadow-sm';
                applianceItem.innerHTML = `
                    <div class="flex-1 w-full sm:w-auto">
                        <p class="font-medium text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500">
                            Potencia: ${item.potencia} W | Consumo/h: ${item.consumo} Wh
                        </p>
                    </div>
                    <div class="flex items-center space-x-2 w-full sm:w-auto mt-2 sm:mt-0">
                        <label for="hours-${index}" class="text-sm text-gray-600 min-w-max">Horas de uso:</label>
                        <input type="number" id="hours-${index}" value="${item.horas}" placeholder="0" min="0" max="24" class="w-20 p-2 border border-gray-300 rounded-lg text-right" data-index="${index}">
                        <button class="remove-btn w-6 h-6 flex items-center justify-center bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                appliancesContainer.appendChild(applianceItem);
            });
            updateButtonStates();
        };
        
        // Guardar datos en Firestore
        async function saveAppliances() {
            if (userId && userDocRef) {
                try {
                    await setDoc(userDocRef, { data: appliances });
                    console.log("Datos guardados en Firestore.");
                } catch (error) {
                    console.error("Error al guardar en Firestore:", error);
                }
            }
        }

        // Cargar datos de Firestore y configurar el listener
        async function loadAppliances() {
            if (userId) {
                userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/appliances`, 'user-list');
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const savedData = docSnap.data().data;
                        if (Array.isArray(savedData)) {
                            appliances = savedData;
                            renderApplianceList();
                        }
                    }
                } catch (error) {
            console.error("Error al cargar datos de Firestore:", error);
                }
            }
        }

        // --- LÓGICA DE CONTROL DE SESIÓN ---
        const setupSessionControl = () => {
            if (!userId) {
                console.error("No se pudo iniciar el control de sesión: userId no disponible.");
                return;
            }
            sessionDocRef = doc(db, `/artifacts/${appId}/public/data/sessions`, userId);
            
            // Reclamar la sesión en la base de datos
            const claimSession = async () => {
                try {
                    await setDoc(sessionDocRef, { deviceId: deviceId, timestamp: new Date() });
                } catch (error) {
                    console.error("Error al reclamar la sesión:", error);
                }
            };

            claimSession(); // Reclamar la sesión al inicio

            // Listener en tiempo real
            onSnapshot(sessionDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const sessionData = docSnap.data();
                    if (sessionData.deviceId !== deviceId) {
                        isSessionActive = false;
                        showLockModal("Esta sesión ha sido terminada porque el software se ha iniciado en otro dispositivo. Por favor, cierra esta ventana.", false);
                    } else {
                        isSessionActive = true;
                        if (!isSoftwareLocked) {
                           hideLockModal();
                        }
                    }
                } else {
                    // Si el documento de sesión no existe, reclamar la sesión
                    claimSession();
                }
            });
        };
        
        // Nuevo: Lógica de control de bloqueo basada en tiempo de uso
        const checkLockStatus = () => {
            if (!userId) {
                console.error("No se puede verificar el estado de bloqueo: userId no disponible.");
                return;
            }

            activationDocRef = doc(db, `/artifacts/${appId}/users/${userId}/lock`, 'activation');
            scheduleDocRef = doc(db, `/artifacts/${appId}/public/data/lockSchedule`, 'schedule');

            onSnapshot(activationDocRef, async (docSnap) => {
                let activationTime = null;
                isFirstUnlockCompleted = false;
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    activationTime = data.activationTime?.toDate();
                    isFirstUnlockCompleted = data.firstUnlockCompleted || false;
                }

                const now = new Date();
                const lockTimeMillis = 1.5 * 60 * 60 * 1000; // 1.5 horas de prueba

                if (!activationTime) {
                    // Primer uso del software, registrar la hora de activación
                    try {
                        await setDoc(activationDocRef, { activationTime: now, firstUnlockCompleted: false });
                        isSoftwareLocked = false;
                        hideLockModal();
                        console.log("Tiempo de activación registrado.");
                    } catch (error) {
                        console.error("Error al registrar el tiempo de activación:", error);
                        isSoftwareLocked = true;
                        showLockModal("Error del sistema. Por favor, reinicia la aplicación.", false);
                    }
                } else {
                    // Ya hay un tiempo de activación
                    if (!isFirstUnlockCompleted) {
                        // Aún no se ha desbloqueado por primera vez
                        if (now.getTime() >= (activationTime.getTime() + lockTimeMillis)) {
                            isSoftwareLocked = true;
                            showLockModal("El período de prueba ha finalizado. Por favor, ingresa la clave 'CLAVE1' para continuar.", true);
                        } else {
                            isSoftwareLocked = false;
                            hideLockModal();
                        }
                    } else {
                        // El primer desbloqueo ya se realizó, ahora se comprueba el siguiente bloqueo programado
                        onSnapshot(scheduleDocRef, (scheduleSnap) => {
                            if (scheduleSnap.exists()) {
                                const scheduleData = scheduleSnap.data()?.schedule || [];
                                const now = new Date();
                                const currentLock = scheduleData.find(entry => now.getTime() >= entry.lockTime.toDate().getTime());
                                if (currentLock) {
                                    isSoftwareLocked = true;
                                    showLockModal(`El software está bloqueado. Por favor, ingresa la clave para desbloquearlo.`, true);
                                } else {
                                    isSoftwareLocked = false;
                                    hideLockModal();
                                }
                            } else {
                                // No hay un horario de bloqueo futuro, el software permanece desbloqueado
                                isSoftwareLocked = false;
                                hideLockModal();
                            }
                        }, (error) => {
                            console.error("Error al obtener el horario de bloqueo:", error);
                            isSoftwareLocked = false;
                            hideLockModal();
                        });
                    }
                }
            }, (error) => {
                console.error("Error al obtener el estado de activación:", error);
                isSoftwareLocked = true;
                showLockModal("Error del sistema. Por favor, reinicia la aplicación.", false);
            });
        };

        // Inicialización y Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Listeners de navegación
            sidebarButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    showSection(btn.id.replace('btn-', ''));
                });
            });

            // Nuevo: Listener para el botón de desbloqueo
            unlockButton.addEventListener('click', async () => {
                const enteredCode = unlockCodeInput.value.trim();
                const activationData = (await getDoc(activationDocRef)).data();
                
                if (enteredCode === firstUnlockCode && !activationData.firstUnlockCompleted) {
                    try {
                        // Generar el calendario de claves futuras
                        const now = new Date();
                        const schedule = futureKeys.map((key, index) => {
                            const lockDate = new Date();
                            lockDate.setMonth(now.getMonth() + (6 * (index + 1)));
                            return {
                                key: key,
                                lockTime: Timestamp.fromDate(lockDate)
                            };
                        });

                        await setDoc(activationDocRef, { firstUnlockCompleted: true, lastUnlockTime: now }, { merge: true });
                        await setDoc(scheduleDocRef, { schedule: schedule });
                        isSoftwareLocked = false;
                        hideLockModal();
                        showSystemMessage("¡Software desbloqueado! ¡Bienvenido de nuevo!");
                    } catch (error) {
                        console.error("Error al actualizar el estado de bloqueo o generar el calendario:", error);
                        showSystemMessage("Error al intentar desbloquear. Por favor, inténtalo de nuevo.");
                    }
                } else {
                    const scheduleSnap = await getDoc(scheduleDocRef);
                    if (scheduleSnap.exists()) {
                        const scheduleData = scheduleSnap.data()?.schedule || [];
                        const now = new Date();
                        const currentLockIndex = scheduleData.findIndex(entry => now.getTime() >= entry.lockTime.toDate().getTime());
                        
                        if (currentLockIndex !== -1 && enteredCode === scheduleData[currentLockIndex].key) {
                            // Elimina el bloqueo actual de la base de datos
                            const updatedSchedule = scheduleData.filter((_, index) => index > currentLockIndex);
                            await setDoc(scheduleDocRef, { schedule: updatedSchedule });
                            isSoftwareLocked = false;
                            hideLockModal();
                            showSystemMessage("¡Software desbloqueado! ¡Bienvenido de nuevo!");
                        } else {
                            showSystemMessage("Clave incorrecta. Por favor, inténtalo de nuevo.");
                        }
                    } else {
                        showSystemMessage("Clave incorrecta. Por favor, inténtalo de nuevo.");
                    }
                }
            });


            // Listeners de Datos del Cliente
            [clientNameInput, clientAddressInput, clientProvinceSelect].forEach(input => {
                input.addEventListener('input', updateClientDataState);
            });

            // Listeners de On-Grid
            annualKwhInput.addEventListener('input', updateButtonStates);
            calculateOnGridButton.addEventListener('click', calculateOnGrid);

            // Listeners de Off-Grid
            applianceSelect.addEventListener('change', () => {
                const selectedOption = applianceSelect.options[applianceSelect.selectedIndex];
                if (selectedOption.textContent.toLowerCase().includes('otro')) {
                    customApplianceModal.classList.remove('hidden');
                }
            });

            addApplianceBtn.addEventListener('click', () => {
                const selectedValue = applianceSelect.value;
                if (selectedValue) {
                    const newAppliance = JSON.parse(selectedValue);
                    if (newAppliance.name.toLowerCase() === 'otro') {
                        showSystemMessage('Por favor, ingresa los datos de tu electrodoméstico personalizado.');
                        customApplianceModal.classList.remove('hidden');
                        return;
                    }
                    const isDuplicate = appliances.some(item => item.name === newAppliance.name);
                    if (!isDuplicate) {
                        newAppliance.horas = 0; // Se inicializa en 0
                        appliances.push(newAppliance);
                        renderApplianceList();
                        saveAppliances();
                    }
                }
            });

            // Listeners para el modal "Otro"
            addCustomApplianceBtn.addEventListener('click', () => {
                const name = customApplianceNameInput.value.trim();
                const power = parseFloat(customAppliancePowerInput.value);
                const consumption = parseFloat(customApplianceConsumptionInput.value);

                if (name && !isNaN(power) && power > 0 && !isNaN(consumption) && consumption > 0) {
                    const newAppliance = { name: name, potencia: power, consumo: consumption, horas: 0 }; // Se inicializa en 0
                    const isDuplicate = appliances.some(item => item.name === newAppliance.name);
                    if (!isDuplicate) {
                        appliances.push(newAppliance);
                        renderApplianceList();
                        saveAppliances();
                        customApplianceModal.classList.add('hidden');
                        customApplianceNameInput.value = '';
                        customAppliancePowerInput.value = '';
                        customApplianceConsumptionInput.value = '';
                    } else {
                        showSystemMessage('Este electrodoméstico ya existe en tu lista.');
                    }
                } else {
                    showSystemMessage('Por favor, completa todos los campos correctamente.');
                }
            });

            cancelCustomApplianceBtn.addEventListener('click', () => {
                customApplianceModal.classList.add('hidden');
            });


            daysOfAutonomyInput.addEventListener('input', updateButtonStates);
            calculateOffGridButton.addEventListener('click', calculateOffGrid);

            // Listeners para los elementos de la lista de electrodomésticos
            appliancesContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-btn')) {
                    const index = parseInt(e.target.closest('.remove-btn').dataset.index);
                    appliances.splice(index, 1);
                    renderApplianceList();
                    saveAppliances();
                }
            });
            appliancesContainer.addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                    const index = parseInt(e.target.dataset.index);
                    const value = parseFloat(e.target.value);
                    if (!isNaN(value) && value >= 0) {
                        appliances[index].horas = value;
                        updateButtonStates();
                        saveAppliances();
                    }
                }
            });

            // Listeners de Termotanque
            personCountInput.addEventListener('input', updateButtonStates);
            hasMinorsInputs.forEach(input => input.addEventListener('change', updateButtonStates));
            hasPressurizerInputs.forEach(input => input.addEventListener('change', updateButtonStates));
            waterTypeSelect.addEventListener('change', updateButtonStates);
            calculateTermotanqueButton.addEventListener('click', calculateTermotanque);

            // Listeners de Modales
            closeModalButton.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });

            // Llenar dropdown de electrodomésticos
            populateApplianceSelect();

            // Autenticar con Firebase y cargar datos
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    loadAppliances();
                    setupSessionControl(); // Iniciar el control de sesión
                    checkLockStatus(); // Iniciar el control de bloqueo
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error al iniciar sesión:", error);
                    }
                }
            });
            
            // Inicializar estado del botón al cargar
            updateButtonStates();
        });
    </script>
</body>
</html>


